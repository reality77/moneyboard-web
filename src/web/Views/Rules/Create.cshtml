@using web.Utils

@model dto.Model.TransactionRecognitionRule

@{
    ViewData["Title"] = $"Créer une règle de reconnaissance";
}

@section Stylesheets
{
}

<h2>Créer une règle de reconnaissance de transactions</h2>

<div>
    <a asp-controller="Rules" asp-action="List">Retour</a>
</div>

<div class="row">
    <div class="col-12">
        <form asp-action="PostCreate" method="POST">
            <div class="table100">
                <div class="table-row">
                    <div class="table-cell table-header">Conditions</div>
                    <div class="table-cell table-header">Actions</div>
                </div>

                <div class="table-row" data-conditions-count="Model.Conditions.Count()">
                    <div class="table-cell">
                        <div class="table100">
                        @for(int ic = 0; ic < Model.Conditions.Count(); ic++)
                        {
                            var condition = Model.Conditions.ElementAt(ic);
                            var rowId = $"rowConditions_{ic}";

                            <div class="table-row" id="@rowId">
                                <div class="table-cell">
                                    @(ic + 1)
                                </div>
                                <div class="table-cell fieldtype">
                                    <select asp-for="Conditions.ElementAt(ic).FieldType" name="Conditions[@ic].FieldType" onchange="onConditionFieldTypeChanged(this, @ic);">
                                        <option value="0">Data field</option>
                                        <option value="1">Tag</option>
                                    </select>
                                </div>
                                <div class="table-cell fieldname">
                                   @* rafraichissement automatique *@
                                </div>
                                <div class="table-cell valueoperator">
                                   @* automatique *@
                                </div>
                                <div class="table-cell value">
                                    <input type="text" asp-for="Conditions.ElementAt(ic).Value" name="Conditions[@ic].Value" />
                                </div>
                            </div>
                        }
                            <div class="table-row">
                                <div class="table-cell">
                                    <button onclick="addCondition">Ajouter une condition</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell">
                        <div class="table100">
                        @for(int ia = 0; ia < Model.Actions.Count(); ia++)
                        {
                            var condition = Model.Actions.ElementAt(ia);
                            var rowId = $"rowActions_{ia}";
                            
                            <div class="table-row" id="@rowId">
                                <div class="table-cell">
                                    @(ia + 1)
                                </div>
                                <div class="table-cell type">
                                    <select asp-for="Actions.ElementAt(ia).Type" name="Actions[@ia].Type" onchange="onActionTypeChanged(this, @ia);">
                                        <option value="0">Set data</option>
                                        <option value="1">Add tag</option>
                                    </select>
                                </div>
                                <div class="table-cell field">
                                    @* rafraichissement automatique *@
                                </div>                                                                 
                                <div class="table-cell">
                                    <input type="text" asp-for="Actions.ElementAt(ia).Field" name="Actions[@ia].Field" />
                                    <input type="text" asp-for="Actions.ElementAt(ia).Value" name="Actions[@ia].Value" />
                                </div>

                            </div>
                        }
                        </div>
                    </div>                
                </div>
            </div>
            <button type="submit">Créer</button>
        </form>
    </div>
</div>


@section Scripts
{
<script lang="javascript">

    $(document).ready(function() {
        @for(int i = 0; i < Model.Conditions.Count(); i++)
        {
        <text>
        refreshConditionsFieldType(@i, '@Model.Conditions.ElementAt(i).FieldName');
        </text>
        }

        @for(int i = 0; i < Model.Actions.Count(); i++)
        {
        <text>
        refreshActionsType(@i, '@Model.Actions.ElementAt(i).Field');
        </text>
        }
    });

    function onConditionFieldTypeChanged(source, conditionIndex) {
        refreshConditionsFieldType(conditionIndex);
    }

    function refreshConditionsFieldType(conditionIndex, value) {
        var rowAccessor = "#rowConditions_"+conditionIndex;
        var fieldType = $('select[name ="Conditions['+conditionIndex+'].FieldType"] option:selected').val();
        var url = "";

        if(fieldType == "1") {
            url = '/rules/selecttagtypes?mode=Conditions&field=FieldName&index=' + conditionIndex + '&value=' + value;
        } else {
            url = '/rules/selectfields?mode=Conditions&field=FieldName&index=' + conditionIndex + '&value=' + value;
        }

        $(rowAccessor + ' .fieldname').load(url, function(responseText, textStatus, jqXHR ) {
            //alert(textStatus);
        });
    }

    function onConditionsFieldNameChanged(source, conditionIndex) {
        refreshConditionsFieldName(conditionIndex);
    }

    function refreshConditionsFieldName(conditionIndex, value) {
        var rowAccessor = "#rowConditions_"+conditionIndex;
        var fieldType = $('select[name ="Conditions['+conditionIndex+'].FieldName"] option:selected').val();
        var url = "";

        url = '/rules/selectvalueoperator?mode=Conditions&field=ValueOperator&index=' + conditionIndex + '&value=' + value;

        $(rowAccessor + ' .valueoperator').load(url, function(responseText, textStatus, jqXHR ) {
            //alert(textStatus);
        });
    }

    function onActionTypeChanged(source, actionIndex) {
        refreshActionsType(actionIndex);
    }

    function refreshActionsType(actionIndex, value) {
        var rowAccessor = "#rowActions_"+actionIndex;
        var fieldType = $('select[name ="Actions['+actionIndex+'].Type"] option:selected').val();
        var url = "";

        if(fieldType == "1") {
            url = '/rules/selecttagtypes?mode=Actions&field=Field&index=' + actionIndex + '&value=' + value;
        } else {
            url = '/rules/selectfields?mode=Actions&field=Field&index=' + actionIndex + '&value=' + value;
        }

        $(rowAccessor + ' .field').load(url, function(responseText, textStatus, jqXHR ) {
            //alert(textStatus);
        });
    }
    
    function onActionsFieldChanged(source, actionIndex) {
        refreshActionsField(actionIndex);
    }

</script>
}
